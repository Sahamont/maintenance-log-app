<!DOCTYPE html>
<html>
<head>
  <title>Create Order</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, button { padding: 5px; }
    table { margin-top: 15px; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

<h2>Create New Order</h2>

<label>Customer Name:</label>
<input type="text" id="customerName">

<h3>Items</h3>
<table id="itemsTable">
  <thead>
    <tr>
      <th>Item Name</th>
      <th>Quantity</th>
      <th>Price</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="addItem">Add Item</button>
<br><br>
<button id="submitOrder">Submit Order</button>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = "https://yumrglreoawfyvviyxgh.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bXJnbHJlb2F3Znl2dml5eGdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NjgxMDIsImV4cCI6MjA2MzM0NDEwMn0.q9Gl79BRgQSzw912C7_3tmmZEtRBMANoi-ALKAk4GxE";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

  const itemsTable = document.querySelector("#itemsTable tbody");
  document.getElementById("addItem").addEventListener("click", () => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" placeholder="Item Name"></td>
      <td><input type="number" placeholder="Quantity" min="1"></td>
      <td><input type="number" placeholder="Price" step="0.01"></td>
      <td><button onclick="this.parentElement.parentElement.remove()">Remove</button></td>
    `;
    itemsTable.appendChild(row);
  });

  document.getElementById("submitOrder").addEventListener("click", async () => {
    const customerName = document.getElementById("customerName").value.trim();
    if (!customerName) {
      alert("Please enter customer name");
      return;
    }

    // Insert order into Orders table
    const { data: orderData, error: orderError } = await supabaseClient
      .from("orders")
      .insert([{ customer_name: customerName }])
      .select();

    if (orderError) {
      console.error(orderError);
      alert("Error creating order");
      return;
    }

    const orderId = orderData[0].id;

    // Insert items into Items table
    const items = [];
    itemsTable.querySelectorAll("tr").forEach(row => {
      const name = row.querySelector("td:nth-child(1) input").value.trim();
      const quantity = parseInt(row.querySelector("td:nth-child(2) input").value);
      const price = parseFloat(row.querySelector("td:nth-child(3) input").value);
      if (name && quantity > 0 && price >= 0) {
        items.push({ order_id: orderId, item_name: name, quantity, price });
      }
    });

    if (items.length > 0) {
      const { error: itemsError } = await supabaseClient
        .from("items")
        .insert(items);
      if (itemsError) {
        console.error(itemsError);
        alert("Error adding items");
        return;
      }
    }

    // Redirect to confirmation page
    window.location.href = `confirmation.html?order_id=${orderId}`;
  });
</script>

</body>
</html>

